### 1. Preparación de Jenkins (Plugins y Métricas)

Para que Prometheus pueda leer los datos de Jenkins, necesitamos que Jenkins exponga un "endpoint" de métricas.

1. **Instalar Plugin**: Ve a *Administrar Jenkins* > *Plugins* > *Available plugins* e instala:
* **Prometheus metrics**: Este plugin expone un endpoint en `http://<tu-ip-jenkins>:8080/prometheus/`.


2. **Configuración**:
* Ve a *Administrar Jenkins* > *System*.
* Busca la sección de **Prometheus**.
* Asegúrate de que el "Path" sea `/prometheus` y, por seguridad inicial, verifica que el acceso no requiera autenticación avanzada para que Prometheus lo alcance fácilmente (puedes ajustar esto luego).


### 2. Infraestructura de Monitoreo (Docker Compose)

Crearemos un entorno aislado para el monitoreo. En tu Ubuntu Server, crea una carpeta llamada `monitoring` y dentro el archivo `docker-compose.yml`.


```yaml
services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    ports:
      - "9090:9090"
    extra_hosts:
      - "host.docker.internal:host-gateway"
  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    restart: unless-stopped

  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    volumes:
      - /var/lib/jenkins/jobs:/var/log/jenkins/jobs:ro # Mapeo de logs de Jenkins
      - ./promtail-config.yml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin # Cambia esto luego

volumes:
  prometheus_data:
  grafana_data:

```

> **Nota técnica**: El parámetro `extra_hosts: "host.docker.internal:host-gateway"` es la clave. Permite que Prometheus, desde adentro del contenedor, se refiera al host de Ubuntu (donde está Jenkins) usando el nombre `host.docker.internal`.

### 3. Configuración de Prometheus (`prometheus.yml`)

En la misma carpeta `monitoring`, crea el archivo de configuración para que Prometheus sepa de dónde sacar los datos.

**Archivo: `prometheus.yml**`

```yaml

global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'jenkins'
    metrics_path: '/prometheus'
    static_configs:
      - targets: ['host.docker.internal:8080']

  - job_name: 'django-api'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['host.docker.internal:8090']

```

### 4. Implementación 

En tu terminal de Ubuntu:
```bash
cd ~/monitoring
docker compose up -d

```

**Verificar Prometheus**:
Ve a `http://<IP_SERVIDOR>:9090`. En el menú *Status* > *Targets*, deberías ver el job `jenkins` en estado **UP**.
3. **Configurar Grafana**:
* Accede a `http://<IP_SERVIDOR>:3000` (User: `admin` / Pass: `admin`).
* Ve a **Connections** > **Data Sources**.
* Añade **Prometheus**.
* En URL pon: `http://prometheus:9090` (usamos el nombre del servicio de Docker).

**Importar Dashboard de Jenkins**:
No necesitas crear uno desde cero. Grafana tiene uno excelente ya hecho:
* Ve a **Dashboards** > **New** > **Import**.
* Usa el ID: **9964** (es el dashboard oficial para el plugin de Prometheus en Jenkins).
* Selecciona tu fuente de datos Prometheus y haz clic en **Import**.

### 5. Sobre los Logs

El plugin de Prometheus se encarga de métricas numéricas (tiempos de build, colas, éxitos/fallos). Para **logs de texto**, el estándar de la industria es usar **Loki** (también de Grafana).

Si en el futuro quieres ver los logs reales de la consola de Jenkins en Grafana, necesitaríamos agregar un contenedor de `promtail` que lea `/var/lib/jenkins/jobs/...` y los envíe a un contenedor de `loki`.
