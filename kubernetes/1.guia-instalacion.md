# Gu√≠a de Instalaci√≥n: Minikube en Ubuntu Server con Docker

> **Entorno objetivo:** Ubuntu Server 20.04 / 22.04 / 24.04 + Docker ya instalado  
> **Resultado final:** Cl√∫ster Kubernetes local funcional listo para el M√≥dulo 01

---

## ¬øQu√© es Kubernetes?

**Kubernetes** (tambi√©n conocido como **K8s**) es una plataforma de c√≥digo abierto dise√±ada para **automatizar el despliegue, escalado y gesti√≥n de aplicaciones en contenedores**.

Fue creado originalmente por Google bas√°ndose en su sistema interno llamado **Borg**, y donado a la **Cloud Native Computing Foundation (CNCF)** en 2014, donde hoy es el proyecto m√°s adoptado del ecosistema cloud native.

### La idea central

> T√∫ declaras **qu√© quieres** (3 r√©plicas de tu app, siempre disponibles).  
> Kubernetes se encarga de **hacer que ocurra y que se mantenga as√≠**, sin importar fallos de hardware, reinicios o picos de tr√°fico.

### ¬øQu√© resuelve Kubernetes que Docker solo no puede?

| Problema en producci√≥n | Docker solo | Kubernetes |
|---|---|---|
| Un contenedor falla a las 3 AM | Queda ca√≠do hasta intervenci√≥n manual | **Auto-reinicio autom√°tico** |
| Necesitas 10 r√©plicas del mismo servicio | Levantar una por una | `replicas: 10` en un YAML |
| Actualizar la imagen sin downtime | Gesti√≥n manual | **Rolling updates** autom√°ticos |
| Distribuir tr√°fico entre instancias | Requiere proxy externo | **Service** nativo con balanceo |
| Gestionar configuraci√≥n y secretos | Variables en el host | **ConfigMaps y Secrets** integrados |

### ¬øQu√© es Minikube?

**Minikube** es una herramienta oficial de la comunidad de Kubernetes que permite ejecutar un **cl√∫ster de Kubernetes en una sola m√°quina**, ideal para desarrollo, aprendizaje y pruebas locales. En lugar de necesitar m√∫ltiples servidores, Minikube crea un nodo completo (Control Plane + Worker) dentro de un **contenedor Docker** en tu m√°quina.

```
Sin Minikube ‚Üí necesitas varias VMs o servidores para tener un cl√∫ster
Con Minikube ‚Üí un solo comando y tienes un cl√∫ster completo en tu m√°quina local
```

---

## ¬øEs compatible el M√≥dulo 01 con Minikube?

**S√≠, 100% compatible.** Minikube es precisamente el entorno recomendado para seguir el M√≥dulo 01.

| Ejercicio del M√≥dulo 01 | Compatible con Minikube |
|---|---|
| `kubectl run`, `get`, `describe`, `logs` | ‚úÖ Completo |
| Crear Deployment con YAML | ‚úÖ Completo |
| Service tipo `ClusterIP` e interno | ‚úÖ Completo |
| Service tipo `NodePort` | ‚úÖ Acceso directo via IP del servidor |
| Service tipo `LoadBalancer` | ‚úÖ Con `minikube tunnel` |
| Escalar r√©plicas | ‚úÖ Completo |
| Namespaces | ‚úÖ Completo |

La **√∫nica diferencia** con un cl√∫ster cloud es c√≥mo se accede a los Services externos desde tu m√°quina local, lo cual se cubre en esta gu√≠a.

---

## Prerrequisitos

Antes de comenzar, verifica lo siguiente en tu Ubuntu Server:

```bash
# 1. Verificar que Docker est√° instalado y el daemon est√° activo
docker version

# Salida esperada (versiones pueden variar):
# Client: Docker Engine - Community
#  Version: 26.x.x
# Server: Docker Engine
#  Engine: running

# 2. Verificar que el servicio Docker est√° habilitado en systemd
sudo systemctl status docker

# 3. Verificar que tu usuario puede ejecutar Docker sin sudo
# (si este comando falla, ver la secci√≥n de configuraci√≥n de usuario m√°s abajo)
docker ps

# 4. Verificar la arquitectura del sistema
uname -m
# Salida esperada: x86_64  (AMD64)  o  aarch64  (ARM64)

# 5. Verificar recursos disponibles (Minikube necesita m√≠nimo 2 CPUs y 2 GB RAM)
nproc          # N√∫mero de CPUs
free -h        # Memoria disponible
df -h /        # Espacio en disco (m√≠nimo 20 GB libres recomendado)
```

---

## Paso 0: Configurar Docker sin sudo (si a√∫n no lo tienes)

Minikube con el driver Docker **debe ejecutarse sin sudo**. Si a√∫n no has configurado esto:

```bash
# Agregar tu usuario al grupo docker
sudo usermod -aG docker $USER

# Aplicar el cambio de grupo SIN necesidad de cerrar sesi√≥n
newgrp docker

# Verificar que ya funciona sin sudo
docker ps
# Debe mostrar la lista de contenedores (vac√≠a est√° bien: "CONTAINER ID   IMAGE   ...")
```

> **Importante:** Si usas `sudo minikube start`, Minikube se instalar√° en el entorno de root y `kubectl` de tu usuario no lo encontrar√°. Siempre trabaja como usuario normal.

---

## Paso 1: Instalar kubectl

`kubectl` es la CLI para comunicarte con el cl√∫ster. Se instala por separado de Minikube.

```bash
# Descargar la √∫ltima versi√≥n estable de kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"

# (Opcional pero recomendado) Verificar la integridad del binario
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl.sha256"
echo "$(cat kubectl.sha256)  kubectl" | sha256sum --check
# Salida esperada: kubectl: OK

# Instalar el binario en el PATH del sistema
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

# Verificar la instalaci√≥n
kubectl version --client

# Salida esperada:
# Client Version: v1.x.x
# Kustomize Version: v5.x.x
```

---

## Paso 2: Instalar Minikube

```bash
# Descargar el binario de Minikube para Linux AMD64
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64

# Instalar el binario en el PATH del sistema
sudo install minikube-linux-amd64 /usr/local/bin/minikube

# Limpiar el archivo descargado
rm minikube-linux-amd64

# Verificar la instalaci√≥n
minikube version

# Salida esperada:
# minikube version: v1.34.x
# commit: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### Para Ubuntu Server ARM64 (Raspberry Pi, AWS Graviton, etc.)

```bash
# Usar el binario ARM64 en lugar del AMD64
curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-arm64
sudo install minikube-linux-arm64 /usr/local/bin/minikube
rm minikube-linux-arm64
```

---

## Paso 3: Configurar Docker como Driver de Minikube

Minikube necesita un **driver** para crear el nodo de Kubernetes. En este caso usaremos Docker, lo que significa que el nodo correr√° como un **contenedor Docker**, sin m√°quinas virtuales adicionales.

### ¬øEs obligatorio ejecutar este comando?

**No.** Minikube tiene detecci√≥n autom√°tica de driver con esta prioridad:

```
1. Driver configurado en minikube config  ‚Üí lo usa
2. Driver pasado por par√°metro --driver=  ‚Üí lo usa
3. Auto-detecci√≥n de lo que est√© instalado:
   - Si encuentra Docker     ‚Üí usa docker
   - Si encuentra KVM2       ‚Üí usa kvm2
   - Si encuentra VirtualBox ‚Üí usa virtualbox
```

Como en tu Ubuntu Server **solo tienes Docker instalado**, Minikube lo detectar√≠a autom√°ticamente y `minikube start` ya usar√≠a Docker sin configurar nada.

**¬øPara qu√© sirve entonces?** Es √∫til cuando hay **m√∫ltiples drivers instalados** en la misma m√°quina (por ejemplo Docker + VirtualBox), para forzar cu√°l se usar√° siempre y evitar comportamientos inesperados.

Se recomienda configurarlo **expl√≠citamente como buena pr√°ctica**:

```bash
# Opcional en Ubuntu Server con solo Docker instalado,
# pero recomendado para dejar la intenci√≥n documentada
minikube config set driver docker

# Verificar la configuraci√≥n guardada
minikube config view
```

### Salida real de estos comandos y qu√© significa cada mensaje

```
‚ùó  These changes will take effect upon a minikube delete and then a minikube start
```
> Minikube avisa que el cambio de driver **no aplica a un cl√∫ster que ya exista**.
> **Si es tu primera instalaci√≥n, ignora este mensaje** ‚Äî no tienes ning√∫n cl√∫ster previo,
> por lo que el driver Docker se usar√° desde el primer `minikube start`.
> Este warning solo es relevante si ya ten√≠as un cl√∫ster creado con otro driver (VirtualBox, KVM, etc.)
> y quisieras cambiarlo.

```
- driver: docker
```
> Confirmaci√≥n de que la configuraci√≥n fue guardada en `~/.minikube/config/config.json`.
> A partir de ahora, cada `minikube start` usar√° Docker autom√°ticamente sin necesidad
> de escribir `--driver=docker` expl√≠citamente.

---

## Paso 4: Iniciar el Cl√∫ster

```bash
# Iniciar Minikube con Docker como driver
minikube start --driver=docker

# Para un cl√∫ster con recursos definidos expl√≠citamente (recomendado en producci√≥n de laboratorio)
minikube start --driver=docker --cpus=2 --memory=4096mb --disk-size=20g
```

```sh
# Comando personaliza en mi caso
minikube start \
  --driver=docker \
  --cpus=4 \
  --memory=8192 \
  --disk-size=40g \
  --kubernetes-version=stable
```
### Salida esperada durante el inicio

```
üòÑ  minikube v1.34.x on Ubuntu 22.04
‚ú®  Using the docker driver based on user configuration
üìå  Using Docker driver with root privileges
üëç  Starting "minikube" primary control-plane node in "minikube" cluster
üöú  Pulling base image v0.0.45 ...
üíæ  Downloading Kubernetes v1.32.x preload ...
üî•  Creating docker container (CPUs=2, Memory=4096MB) ...
üê≥  Preparing Kubernetes v1.32.x on Docker 26.x.x ...
    ‚ñ™ Generating certificates and keys ...
    ‚ñ™ Booting up control plane ...
    ‚ñ™ Configuring RBAC rules ...
üîó  Configuring bridge CNI (Container Networking Interface) ...
üîé  Verifying Kubernetes components...
    ‚ñ™ Using image gcr.io/k8s-minikube/storage-provisioner:v5
üåü  Enabled addons: storage-provisioner, default-storageclass
üèÑ  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default
```

> El proceso tarda entre **2 y 5 minutos** en la primera ejecuci√≥n porque descarga la imagen base de Kubernetes. Las siguientes son mucho m√°s r√°pidas.

---

## Paso 5: Verificar que el Cl√∫ster est√° Funcionando

```bash
# Ver el estado general del cl√∫ster
minikube status

# Salida esperada:
# minikube
# type: Control Plane
# host: Running
# kubelet: Running
# apiserver: Running
# kubeconfig: Configured

# Ver los nodos del cl√∫ster (Minikube crea un cl√∫ster de un solo nodo)
kubectl get nodes

# Salida esperada:
# NAME       STATUS   ROLES           AGE   VERSION
# minikube   Ready    control-plane   2m    v1.32.x

# Ver todos los Pods de los componentes internos de Kubernetes
kubectl get pods --namespace=kube-system

# Ver la informaci√≥n del cl√∫ster
kubectl cluster-info

# Salida esperada:
# Kubernetes control plane is running at https://192.168.49.2:8443
# CoreDNS is running at https://192.168.49.2:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy